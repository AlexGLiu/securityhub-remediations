AWSTemplateFormatVersion: '2010-09-09'
Description: 'Security Hub Remediations Workshop - Base Environment'
Parameters:
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'

Resources:
  SecHubWorkshopEnv:
    Type: AWS::Cloud9::EnvironmentEC2
    Properties: 
      Description: Security Hub Remediations Workshop
      InstanceType: t2.micro
      Name: SecHubWorkshop
  
  Cloud9InstancePolicy:
    Type: AWS::IAM::Policy
    Properties: 
      PolicyName: Cloud9RemediationTesting
      Roles: 
        - Ref "Cloud9Instance"
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          -
            Effect: Allow
            Action: 
              - "ec2:StartInstance"
              - "ec2:Describe*"
              - "guardduty:CreateSampleFindings"
            Resource: "*"
          -    
            Effect: Allow
            Action: 
              - "logs:CreateLogStream"
              - "logs:CreateLogGroup"
              - "logs:PutLogEvents"
            Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ssm/AWS-RunShellScript*'
          -
            Effect: Allow
            Action: 
              - "ssm:SendCommand"
              - "ssm:DescribeAssociation"
              - "ssm:GetDeployablePatchSnapshotForInstance"
              - "ssm:GetDocument"
              - "ssm:DescribeDocument"
              - "ssm:GetManifest"
              - "ssm:GetParameters"
              - "ssm:ListAssociations"
              - "ssm:ListInstanceAssociations"
              - "ssm:PutInventory"
              - "ssm:PutComplianceItems"
              - "ssm:PutConfigurePackageResult"
              - "ssm:StartAutomationExecution"
              - "ssm:UpdateAssociationStatus"
              - "ssm:UpdateInstanceAssociationStatus"
              - "ssm:UpdateInstanceInformation"
            Resource: "*"
          -
            Effect: Allow
            Action:
              - "ssmmessages:CreateControlChannel"
              - "ssmmessages:CreateDataChannel"
              - "ssmmessages:OpenControlChannel"
              - "ssmmessages:OpenDataChannel"
              - "ec2messages:AcknowledgeMessage"
              - "ec2messages:DeleteMessage"
              - "ec2messages:FailMessage"
              - "ec2messages:GetEndpoint"
              - "ec2messages:GetMessages"
              - "ec2messages:SendReply"
            Resource: "*"

  CloudCustodianPolicy:
    Type: AWS::IAM::Policy
    Properties: 
      PolicyName: CloudCustodian
      Roles: 
        - Ref: "CloudCustodian"
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          -
            Sid": "CCWrite"
            Effect: Allow
            Action: 
              - "ssm:SendCommand"
              - "ssm:CreateOpsItem"
              - "iam:DeleteAccessKey"
              - "iam:UpdateAccessKey"
              - "iam:Tag*"
              - "iam:UnTag*"
              - "kms:UntagResource"
              - "kms:TagResource"
              - "events:PutRule"
              - "events:PutTargets"
              - "ec2:CreateImage"
              - "ec2:CreateSnapshot*"
              - "ec2:CreateTags"
              - "ec2:DeleteTags"
              - "ec2:ModifyVpcAttribute"
              - "ec2:ModifyInstanceAttribute"
              - "ec2:AssociateIamInstanceProfile"
              - "ec2:DisassociateIamInstanceProfile"
              - "ec2:StopInstances"
              - "ec2:TerminateInstances"
              - "config:PutEvaluations"
              - "s3:PutBucketTagging"
              - "tag:TagResources"
              - "tag:UntagResources"
            Resource: "*"
          -
            Sid: "CCDeployLambdas"
            Effect: Allow"
            Action: 
              - "lambda:CreateFunction"
              - "lambda:TagResource"
              - "lambda:InvokeFunction"
              - "lambda:UpdateFunctionConfiguration"
              - "lambda:UntagResource"
              - "lambda:UpdateAlias"
              - "lambda:UpdateFunctionCode"
              - "lambda:AddPermission"
              - "lambda:DeleteFunction"
              - "lambda:RemovePermission"
              - "lambda:CreateAlias"
              - "lambda:GetFunction"
            Resource:
              - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:custodian-*'
          -
            Sid: "CCPassRole"
            Effect: Allow
            Action:
              - "iam:PassRole"
            Resource:
              - !Sub 'arn:aws:iam::${AWS::AccountId}:role/CloudCustodian'
          -
            Sid: "CCSecurityHub"
            Effect: "Allow"
            Action:
              - "securityhub:UpdateFindings"
              - "securityhub:BatchImportFindings"
              - "securityhub:CreateActionTarget"
              - "securityhub:UpdateActionTarget"
              - "securityhub:Describe*"
            Resource: "*"
          -
            Sid: "CCLogs"
            Effect: "Allow"
            Action: 
              - "logs:CreateLogStream"
              - "logs:CreateLogGroup"
              - "logs:PutLogEvents"
            Resource: 
              - !Sub 'arn:aws:logs::${AWS::AccountId}:log-group:/aws/lambda/custodian-*'
  
  Cloud9Instance:            
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com" 
            Action: 
              - "sts:AssumeRole"
     Path: "/"

  Cloud9InstanceProfile:
   Type: "AWS::IAM::InstanceProfile"
   Properties:
     Path: "/"
     Roles:
       -
         Ref: "Cloud9Instance"
